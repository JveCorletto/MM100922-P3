flowchart LR
    subgraph Client["**Cliente (Browser)**"]
        direction TB
        A("Next.js 14 App Router\nSesiones con cookies seguras SSR"):::primary
    end

    subgraph Vercel["**Vercel · Next.js 14 (App Router)**"]
        VM("Runtime: Node.js Serverless\nAPI Routes + Middleware SSR\n- Autenticación Supabase SSR\n- Generación diplomas pdf-lib\n- Endpoints IA: /api/ia/summary, /api/chat/course-assistant\n- SSR sin ISR en páginas públicas"):::primary
    end

    CDN["**CDN Vercel**\nAssets estáticos: CSS · JS · Imágenes\nCaching en edge"]:::storage

    subgraph Supabase["**Supabase - us-east-2 (NANO)**"]
        direction TB
        AUTH{"Supabase Auth\n- Email verification\n- Magic Link\n- 2FA TOTP obligatorio:\n  - Tutores: crear/modificar cursos\n  - Estudiantes: inscripción cursos"}:::secondary

        DB(("Supabase Postgres")):::db
        DB_CONTENT["profiles · courses · lessons\nenrollments · messages · course_diplomas\n- RLS: rol/ownership\n- Backups automáticos NANO"]:::db_content

        STG[["Supabase Storage\n- Bucket privado: materials\n- RLS: tutor owner / estudiantes enrolled\n- Estructura: materials/{course_id}/{lesson_id}/{file}\n- Signed URLs (60 min)"]]:::storage

        RT(["Supabase Realtime\n- Chat por curso exclusivamente\n- Sin notificaciones/presencia"]):::realtime

        DB --> DB_CONTENT
    end

    AI[">Gemini (Google AI)\n- Producción: modelo real\n- Desarrollo: mock sin API Key\n- Límite: 32k tokens/request"]:::external

    OBS("Observabilidad & Seguridad\n- Vercel Analytics + Supabase Logs\n- Secrets: Env Vars Vercel/Supabase\n- RPS: < 10 req/s\n- Archivos: 5-20MB promedio"):::observability

    PAY("Roadmap: Pasarela Pagos\n- PayPal / Wompy\n- Integración en API Routes existentes"):::external

    %% Connection Arrows
    A -->|HTTPS| VM
    VM --> CDN
    VM -->|"Auth SSR Middleware"| AUTH
    VM -->|"CRUD (RLS)"| DB
    VM -->|"Storage API"| STG
    VM -->|"Realtime Subscription"| RT
    VM -->|HTTP/JSON| AI
    VM -.->|Monitoreo| OBS
    VM -->|Futura integración| PAY
    OBS -. logs .- Supabase

    %% Classes for theme
    classDef primary fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef secondary fill:#ede7f6,stroke:#512da8,stroke-width:2.5px
    classDef storage fill:#e8f5e9,stroke:#388e3c,stroke-width:2px
    classDef external fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef db fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef db_content fill:#ede7f6,stroke:#6a1b9a,stroke-width:2px
    classDef observability fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,stroke-dasharray: 2 2
    classDef realtime fill:#ffe0b2,stroke:#e65100,stroke-width:2px

    class Client,Vercel primary
    class Supabase secondary
    class CDN,STG storage
    class AI,PAY external
    class DB,DB_CONTENT db,db_content
    class OBS observability
    class RT realtime