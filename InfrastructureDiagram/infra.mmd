flowchart TB
    %% USUARIOS
    USERS["*Usuarios Finales*<br/>Estudiantes & Tutores"]
    
    %% CLIENTE
    subgraph CLIENT_LAYER["*Capa Cliente*"]
        BROWSER["*Navegador Web*<br/>- Next.js 14 SSR<br/>- Sesiones con cookies seguras<br/>- WebSockets para chat en tiempo real"]
    end
    
    %% EDGE / CDN
    subgraph EDGE_LAYER["*Capa Edge*"]
        VERCEL_CDN["*CDN Vercel (Edge)*<br/>- Assets estáticos<br/>- CSS, JS, Imágenes<br/>- Caching global"]
        
        subgraph EDGE_FUNCTIONS["*Edge Functions*"]
            MIDDLEWARE["*Middleware SSR*<br/>- Autenticación<br/>- Routing"]
        end
    end
    
    %% COMPUTE
    subgraph COMPUTE_LAYER["*Capa de Computación*"]
        subgraph SERVERLESS["*Vercel Serverless*"]
            API_ROUTES["*API Routes*<br/>Runtime: Node.js<br/>- /api/ia/summary<br/>- /api/chat/course-assistant<br/>- Generación diplomas (pdf-lib)"]
            
            SSR["*Server-Side Rendering*<br/>- Páginas públicas sin ISR<br/>- Autenticación Supabase SSR"]
        end
    end
    
    %% DATABASE & STORAGE
    subgraph DATA_LAYER["*Capa de Datos - Supabase (us-east-2)*"]
        subgraph AUTH_SERVICE["*Servicio de Autenticación*"]
            AUTH["*Supabase Auth*<br/>- Email verification<br/>- Magic Link<br/>- 2FA TOTP obligatorio"]
        end
        
        subgraph DATABASE["*Base de Datos*"]
            POSTGRES["*PostgreSQL Cluster*<br/>NANO Tier<br/>- Backups automáticos"]
            
            RLS["*Row Level Security*<br/>- Políticas por rol/ownership<br/>- profiles, courses, lessons<br/>- enrollments, messages"]
        end
        
        subgraph STORAGE["*Almacenamiento*"]
            STORAGE_BUCKET["*Supabase Storage*<br/>- Bucket privado: materials<br/>- materials/{course_id}/{lesson_id}/<br/>- Signed URLs (60min)"]
        end
        
        subgraph REALTIME["*Servicios en Tiempo Real*"]
            REALTIME_SVC["*Supabase Realtime*<br/>- WebSockets<br/>- Chat por curso<br/>- Sin notificaciones/presencia"]
        end
    end
    
    %% EXTERNAL SERVICES
    subgraph EXTERNAL_LAYER["*Servicios Externos*"]
        AI_SERVICE["*Google AI - Gemini*<br/>- Producción: modelo real<br/>- Desarrollo: mock<br/>- Límite: 32k tokens/request"]
        
        PAYMENT["*Pasarelas de Pago*<br/>(Roadmap)<br/>- PayPal<br/>- Wompy"]
    end
    
    %% MONITORING
    subgraph OBSERVABILITY["*Observabilidad*"]
        MONITORING["*Sistema de Monitoreo*<br/>- Vercel Analytics<br/>- Supabase Logs<br/>- Secrets: Env Vars<br/>- RPS: < 10 req/s"]
    end
    
    %% CONEXIONES PRINCIPALES
    USERS -->|HTTPS| BROWSER
    BROWSER -->|SSR Requests| EDGE_FUNCTIONS
    BROWSER -->|WebSockets| REALTIME_SVC
    
    EDGE_FUNCTIONS -->|Serverless Invocations| SERVERLESS
    EDGE_FUNCTIONS -->|Static Assets| VERCEL_CDN
    
    SERVERLESS -->|Auth Requests| AUTH_SERVICE
    SERVERLESS -->|Database Queries| DATABASE
    SERVERLESS -->|Storage Operations| STORAGE
    SERVERLESS -->|AI API Calls| AI_SERVICE
    SERVERLESS -->|Future Integration| PAYMENT
    
    AUTH_SERVICE -->|User Validation| DATABASE
    REALTIME_SVC -->|Database Changes| DATABASE
    
    %% MONITORING CONNECTIONS
    SERVERLESS -.->|Metrics & Logs| MONITORING
    DATA_LAYER -.->|Database Logs| MONITORING
    
    %% STYLING
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef edge fill:#bbdefb,stroke:#0277bd,stroke-width:2px
    classDef compute fill:#c8e6c9,stroke:#388e3c,stroke-width:2px
    classDef data fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef external fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef monitoring fill:#e3f2fd,stroke:#1976d2,stroke-width:2px,stroke-dasharray: 2 2
    
    class BROWSER,CLIENT_LAYER client
    class EDGE_LAYER,EDGE_FUNCTIONS edge
    class COMPUTE_LAYER,SERVERLESS compute
    class DATA_LAYER,AUTH_SERVICE,DATABASE,STORAGE,REALTIME data
    class EXTERNAL_LAYER,AI_SERVICE,PAYMENT external
    class OBSERVABILITY,MONITORING monitoring